<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!-- NewPage -->
<html lang="en">
<head>
<!-- Generated by javadoc (1.8.0_111) on Tue Dec 18 04:04:33 MST 2018 -->
<title>ReorganizeFile</title>
<meta name="date" content="2018-12-18">
<link rel="stylesheet" type="text/css" href="../../../../stylesheet.css" title="Style">
<script type="text/javascript" src="../../../../script.js"></script>
</head>
<body>
<script type="text/javascript"><!--
    try {
        if (location.href.indexOf('is-external=true') == -1) {
            parent.document.title="ReorganizeFile";
        }
    }
    catch(err) {
    }
//-->
var methods = {"i0":10,"i1":9,"i2":10,"i3":10,"i4":9};
var tabs = {65535:["t0","All Methods"],1:["t1","Static Methods"],2:["t2","Instance Methods"],8:["t4","Concrete Methods"]};
var altColor = "altColor";
var rowColor = "rowColor";
var tableTab = "tableTab";
var activeTableTab = "activeTableTab";
</script>
<noscript>
<div>JavaScript is disabled on your browser.</div>
</noscript>
<!-- ========= START OF TOP NAVBAR ======= -->
<div class="topNav"><a name="navbar.top">
<!--   -->
</a>
<div class="skipNav"><a href="#skip.navbar.top" title="Skip navigation links">Skip navigation links</a></div>
<a name="navbar.top.firstrow">
<!--   -->
</a>
<ul class="navList" title="Navigation">
<li><a href="../../../../overview-summary.html">Overview</a></li>
<li><a href="package-summary.html">Package</a></li>
<li class="navBarCell1Rev">Class</li>
<li><a href="package-tree.html">Tree</a></li>
<li><a href="../../../../deprecated-list.html">Deprecated</a></li>
<li><a href="../../../../index-all.html">Index</a></li>
<li><a href="../../../../help-doc.html">Help</a></li>
</ul>
</div>
<div class="subNav">
<ul class="navList">
<li><a href="../../../../gov/usgs/anss/msread/RawDiskBigBuffer.html" title="class in gov.usgs.anss.msread"><span class="typeNameLink">Prev&nbsp;Class</span></a></li>
<li><a href="../../../../gov/usgs/anss/msread/ReorganizeFile.ChannelProcess.html" title="class in gov.usgs.anss.msread"><span class="typeNameLink">Next&nbsp;Class</span></a></li>
</ul>
<ul class="navList">
<li><a href="../../../../index.html?gov/usgs/anss/msread/ReorganizeFile.html" target="_top">Frames</a></li>
<li><a href="ReorganizeFile.html" target="_top">No&nbsp;Frames</a></li>
</ul>
<ul class="navList" id="allclasses_navbar_top">
<li><a href="../../../../allclasses-noframe.html">All&nbsp;Classes</a></li>
</ul>
<div>
<script type="text/javascript"><!--
  allClassesLink = document.getElementById("allclasses_navbar_top");
  if(window==top) {
    allClassesLink.style.display = "block";
  }
  else {
    allClassesLink.style.display = "none";
  }
  //-->
</script>
</div>
<div>
<ul class="subNavList">
<li>Summary:&nbsp;</li>
<li><a href="#nested.class.summary">Nested</a>&nbsp;|&nbsp;</li>
<li><a href="#field.summary">Field</a>&nbsp;|&nbsp;</li>
<li><a href="#constructor.summary">Constr</a>&nbsp;|&nbsp;</li>
<li><a href="#method.summary">Method</a></li>
</ul>
<ul class="subNavList">
<li>Detail:&nbsp;</li>
<li><a href="#field.detail">Field</a>&nbsp;|&nbsp;</li>
<li><a href="#constructor.detail">Constr</a>&nbsp;|&nbsp;</li>
<li><a href="#method.detail">Method</a></li>
</ul>
</div>
<a name="skip.navbar.top">
<!--   -->
</a></div>
<!-- ========= END OF TOP NAVBAR ========= -->
<!-- ======== START OF CLASS DATA ======== -->
<div class="header">
<div class="subTitle">gov.usgs.anss.msread</div>
<h2 title="Class ReorganizeFile" class="title">Class ReorganizeFile</h2>
</div>
<div class="contentContainer">
<ul class="inheritance">
<li>java.lang.Object</li>
<li>
<ul class="inheritance">
<li>gov.usgs.anss.msread.ReorganizeFile</li>
</ul>
</li>
</ul>
<div class="description">
<ul class="blockList">
<li class="blockList">
<dl>
<dt>All Implemented Interfaces:</dt>
<dd><a href="../../../../gov/usgs/anss/edge/MiniSeedOutputHandler.html" title="interface in gov.usgs.anss.edge">MiniSeedOutputHandler</a></dd>
</dl>
<hr>
<br>
<pre>public final class <span class="typeNameLabel">ReorganizeFile</span>
extends java.lang.Object
implements <a href="../../../../gov/usgs/anss/edge/MiniSeedOutputHandler.html" title="interface in gov.usgs.anss.edge">MiniSeedOutputHandler</a></pre>
<div class="block">This class takes a miniSEED file from an EdgeCWB system and creates a new one while compressing
 out badly compressed or intentionally short data, and puts the data out in large sections channel
 by channel so that queries work faster. The class uses the RawDiskBigBuffer class to read big
 swaths of the file into a memory buffer, and then hand out these data as though they are blocks
 read from disk. This reduces the number of IOs for input by a huge amount.
 
 <p>
 The process creates a computation object for each channel and then a user controlled number of
 computation threads which round robin the computation object each time a new section of data is
 read in. When each new section is read the first block of each extent is read and a structure
 containing all of the extents for each channel is created.
 <p>
 For each channel computation: From this list of extents for this channel create an array of
 miniSEED blocks for all extents in this channel in the RawDiskBigBuffer.  Sort these blocks and eliminate any duplicate blocks.
 For each remaining block call the status object to collect status on
 number of blocks, number of out-of-order blocks, total Steim frames used. 
 
 <p>  If the -compress switch is used, then if the average number of used 
 frames per block is less than 6, then the assembled blocks are decompressed and RawToMiniSeed is used
 to compress the data into new miniSEED blocks.   If average used frames > 6, then preserve the
 miniSEED blocks as they are 
 and put them in the output file unchanged (duplicates having been eliminated).
 <p>
 For massively duplicated data files (data loops usually), the -massive option performs a search of
 the last NNNN blocks as the blocks are assembled and eliminates adding a new block if a duplicate is
 found.  This was necessary because massively duplicated blocks created very large number
 of miniSEED blocks from the MiniSeedPool causing memory to run out before the normal "load all the blocks, 
 sort them and then eliminate" them occurred.  Do not use this on files with small amounts of duplicates
 as the look back for each block is compute intensive.
 <p>
 On completion of a file, the statistics gathered during the processing are output. This include
 the number of input blocks, the number of output blocks, the number of data frames in the input,
 the number of blocks that are out-of-order on the input, the number of duplicate blocks
 eliminated, and some percentages based on this values. In addition a listing of the "Runs". that is,
 contiguous data runs is output with a limit of 10 Runs.
<p>
 This software was funded in large part by Cal Tech as a means to shrink their archive files and to 
 reorder the data so that large queries would run faster for reorganized files in the archive.  It is based
 on software already in the EdgeCWB project used to build a index file from the miniSEED file should
 the index be lost or corrupted.  It also uses elements of the software used to do the nightly scan of
 data files to produce statistics, spot oddities, and create fetchlist entries (updateHoldings scan).
 <pre>

 Usage :  java -XmxNNNNNm $PATHTOBIN/msread.jar -datapath path [-compress][-mb nnnn][-npermit nn]] [-massive NNNNN] [MiniSEED FILES]
 This program is normally invoked by the reorgDay.bash script.
 Note the size of the buffer used depends on the setting of the -XmxNNNNNm which must be 2000 mB bigger that the buffer
  switch   args     Description
 -reorg           This switch tells msread to run the Reorganizer file function
 -compress        If present, allow recompression of channels that would benefit from it.
 -mb      NNNNN   Use a input buffer size of this amount, the bigger the better in mB.
 -alloc   NNNNN   Size in mB of each allocated buffer in the Disk cache
 -datapath path   This is the path where the output files will be created.
 -npermit  nn     This is the number of threads used to process the data (def=16)
 -massive nnnn    If a file has massive duplications, find them by looking back nnnn blocks as loading (def=0, 20000 is safe)
 </PRE></div>
</li>
</ul>
</div>
<div class="summary">
<ul class="blockList">
<li class="blockList">
<!-- ======== NESTED CLASS SUMMARY ======== -->
<ul class="blockList">
<li class="blockList"><a name="nested.class.summary">
<!--   -->
</a>
<h3>Nested Class Summary</h3>
<table class="memberSummary" border="0" cellpadding="3" cellspacing="0" summary="Nested Class Summary table, listing nested classes, and an explanation">
<caption><span>Nested Classes</span><span class="tabEnd">&nbsp;</span></caption>
<tr>
<th class="colFirst" scope="col">Modifier and Type</th>
<th class="colLast" scope="col">Class and Description</th>
</tr>
<tr class="altColor">
<td class="colFirst"><code>class&nbsp;</code></td>
<td class="colLast"><code><span class="memberNameLink"><a href="../../../../gov/usgs/anss/msread/ReorganizeFile.ChannelProcess.html" title="class in gov.usgs.anss.msread">ReorganizeFile.ChannelProcess</a></span></code>
<div class="block">This thread rProcesses a segment in the RawDiskBuffer and gathers statistics.</div>
</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><code>class&nbsp;</code></td>
<td class="colLast"><code><span class="memberNameLink"><a href="../../../../gov/usgs/anss/msread/ReorganizeFile.ChannelThread.html" title="class in gov.usgs.anss.msread">ReorganizeFile.ChannelThread</a></span></code>
<div class="block">This class is a thread which runs one ChannelProcess at a time, and then makes itself free
 to run another channel.</div>
</td>
</tr>
<tr class="altColor">
<td class="colFirst"><code>class&nbsp;</code></td>
<td class="colLast"><code><span class="memberNameLink"><a href="../../../../gov/usgs/anss/msread/ReorganizeFile.MonitorReorg.html" title="class in gov.usgs.anss.msread">ReorganizeFile.MonitorReorg</a></span></code>&nbsp;</td>
</tr>
</table>
</li>
</ul>
<!-- =========== FIELD SUMMARY =========== -->
<ul class="blockList">
<li class="blockList"><a name="field.summary">
<!--   -->
</a>
<h3>Field Summary</h3>
<table class="memberSummary" border="0" cellpadding="3" cellspacing="0" summary="Field Summary table, listing fields, and an explanation">
<caption><span>Fields</span><span class="tabEnd">&nbsp;</span></caption>
<tr>
<th class="colFirst" scope="col">Modifier and Type</th>
<th class="colLast" scope="col">Field and Description</th>
</tr>
<tr class="altColor">
<td class="colFirst"><code>protected java.util.TreeMap&lt;java.lang.String,java.util.ArrayList&lt;java.lang.Integer&gt;&gt;</code></td>
<td class="colLast"><code><span class="memberNameLink"><a href="../../../../gov/usgs/anss/msread/ReorganizeFile.html#chans">chans</a></span></code>&nbsp;</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><code>protected java.util.TreeMap&lt;java.lang.String,gov.usgs.anss.msread.ReorganizeFile.Status&gt;</code></td>
<td class="colLast"><code><span class="memberNameLink"><a href="../../../../gov/usgs/anss/msread/ReorganizeFile.html#status">status</a></span></code>&nbsp;</td>
</tr>
</table>
</li>
</ul>
<!-- ======== CONSTRUCTOR SUMMARY ======== -->
<ul class="blockList">
<li class="blockList"><a name="constructor.summary">
<!--   -->
</a>
<h3>Constructor Summary</h3>
<table class="memberSummary" border="0" cellpadding="3" cellspacing="0" summary="Constructor Summary table, listing constructors, and an explanation">
<caption><span>Constructors</span><span class="tabEnd">&nbsp;</span></caption>
<tr>
<th class="colOne" scope="col">Constructor and Description</th>
</tr>
<tr class="altColor">
<td class="colOne"><code><span class="memberNameLink"><a href="../../../../gov/usgs/anss/msread/ReorganizeFile.html#ReorganizeFile-boolean-java.lang.String-int-int-int-int-">ReorganizeFile</a></span>(boolean&nbsp;compressPartial,
              java.lang.String&nbsp;msFilename,
              int&nbsp;mbBufAlloc,
              int&nbsp;mbBuf,
              int&nbsp;npermit,
              int&nbsp;massive)</code>&nbsp;</td>
</tr>
</table>
</li>
</ul>
<!-- ========== METHOD SUMMARY =========== -->
<ul class="blockList">
<li class="blockList"><a name="method.summary">
<!--   -->
</a>
<h3>Method Summary</h3>
<table class="memberSummary" border="0" cellpadding="3" cellspacing="0" summary="Method Summary table, listing methods, and an explanation">
<caption><span id="t0" class="activeTableTab"><span>All Methods</span><span class="tabEnd">&nbsp;</span></span><span id="t1" class="tableTab"><span><a href="javascript:show(1);">Static Methods</a></span><span class="tabEnd">&nbsp;</span></span><span id="t2" class="tableTab"><span><a href="javascript:show(2);">Instance Methods</a></span><span class="tabEnd">&nbsp;</span></span><span id="t4" class="tableTab"><span><a href="javascript:show(8);">Concrete Methods</a></span><span class="tabEnd">&nbsp;</span></span></caption>
<tr>
<th class="colFirst" scope="col">Modifier and Type</th>
<th class="colLast" scope="col">Method and Description</th>
</tr>
<tr id="i0" class="altColor">
<td class="colFirst"><code>void</code></td>
<td class="colLast"><code><span class="memberNameLink"><a href="../../../../gov/usgs/anss/msread/ReorganizeFile.html#close--">close</a></span>()</code>&nbsp;</td>
</tr>
<tr id="i1" class="rowColor">
<td class="colFirst"><code>static void</code></td>
<td class="colLast"><code><span class="memberNameLink"><a href="../../../../gov/usgs/anss/msread/ReorganizeFile.html#main-java.lang.String:A-">main</a></span>(java.lang.String[]&nbsp;args)</code>&nbsp;</td>
</tr>
<tr id="i2" class="altColor">
<td class="colFirst"><code>void</code></td>
<td class="colLast"><code><span class="memberNameLink"><a href="../../../../gov/usgs/anss/msread/ReorganizeFile.html#putbuf-byte:A-int-">putbuf</a></span>(byte[]&nbsp;msbuf,
      int&nbsp;len)</code>
<div class="block">Handle the output from the RawToMiniSeed.</div>
</td>
</tr>
<tr id="i3" class="rowColor">
<td class="colFirst"><code>void</code></td>
<td class="colLast"><code><span class="memberNameLink"><a href="../../../../gov/usgs/anss/msread/ReorganizeFile.html#setDebug-boolean-">setDebug</a></span>(boolean&nbsp;t)</code>&nbsp;</td>
</tr>
<tr id="i4" class="altColor">
<td class="colFirst"><code>static void</code></td>
<td class="colLast"><code><span class="memberNameLink"><a href="../../../../gov/usgs/anss/msread/ReorganizeFile.html#setDebugChannel-java.lang.String-">setDebugChannel</a></span>(java.lang.String&nbsp;chan)</code>&nbsp;</td>
</tr>
</table>
<ul class="blockList">
<li class="blockList"><a name="methods.inherited.from.class.java.lang.Object">
<!--   -->
</a>
<h3>Methods inherited from class&nbsp;java.lang.Object</h3>
<code>clone, equals, finalize, getClass, hashCode, notify, notifyAll, toString, wait, wait, wait</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="details">
<ul class="blockList">
<li class="blockList">
<!-- ============ FIELD DETAIL =========== -->
<ul class="blockList">
<li class="blockList"><a name="field.detail">
<!--   -->
</a>
<h3>Field Detail</h3>
<a name="chans">
<!--   -->
</a>
<ul class="blockList">
<li class="blockList">
<h4>chans</h4>
<pre>protected&nbsp;java.util.TreeMap&lt;java.lang.String,java.util.ArrayList&lt;java.lang.Integer&gt;&gt; chans</pre>
</li>
</ul>
<a name="status">
<!--   -->
</a>
<ul class="blockListLast">
<li class="blockList">
<h4>status</h4>
<pre>protected&nbsp;java.util.TreeMap&lt;java.lang.String,gov.usgs.anss.msread.ReorganizeFile.Status&gt; status</pre>
</li>
</ul>
</li>
</ul>
<!-- ========= CONSTRUCTOR DETAIL ======== -->
<ul class="blockList">
<li class="blockList"><a name="constructor.detail">
<!--   -->
</a>
<h3>Constructor Detail</h3>
<a name="ReorganizeFile-boolean-java.lang.String-int-int-int-int-">
<!--   -->
</a>
<ul class="blockListLast">
<li class="blockList">
<h4>ReorganizeFile</h4>
<pre>public&nbsp;ReorganizeFile(boolean&nbsp;compressPartial,
                      java.lang.String&nbsp;msFilename,
                      int&nbsp;mbBufAlloc,
                      int&nbsp;mbBuf,
                      int&nbsp;npermit,
                      int&nbsp;massive)</pre>
<dl>
<dt><span class="paramLabel">Parameters:</span></dt>
<dd><code>compressPartial</code> - If true, channels that appear to be less than fully compressed can be
 compressed</dd>
<dd><code>msFilename</code> - Filename(full path) of the .ms file to process</dd>
<dd><code>mbBufAlloc</code> - the size in megabytes of each buffer segment</dd>
<dd><code>mbBuf</code> - The amount of memory to put in the RawDiskBigBuffer for reading the files
 efficiently</dd>
<dd><code>npermit</code> - The number of semaphores for channels to run simultaneously (0 = run all)</dd>
<dd><code>massive</code> - If true, do scan for massive duplications</dd>
</dl>
</li>
</ul>
</li>
</ul>
<!-- ============ METHOD DETAIL ========== -->
<ul class="blockList">
<li class="blockList"><a name="method.detail">
<!--   -->
</a>
<h3>Method Detail</h3>
<a name="setDebug-boolean-">
<!--   -->
</a>
<ul class="blockList">
<li class="blockList">
<h4>setDebug</h4>
<pre>public&nbsp;void&nbsp;setDebug(boolean&nbsp;t)</pre>
<dl>
<dt><span class="paramLabel">Parameters:</span></dt>
<dd><code>t</code> - Set debug on or off.</dd>
</dl>
</li>
</ul>
<a name="setDebugChannel-java.lang.String-">
<!--   -->
</a>
<ul class="blockList">
<li class="blockList">
<h4>setDebugChannel</h4>
<pre>public static&nbsp;void&nbsp;setDebugChannel(java.lang.String&nbsp;chan)</pre>
<dl>
<dt><span class="paramLabel">Parameters:</span></dt>
<dd><code>chan</code> - Set the channel name which will have more output (uses contains()) to match</dd>
</dl>
</li>
</ul>
<a name="close--">
<!--   -->
</a>
<ul class="blockList">
<li class="blockList">
<h4>close</h4>
<pre>public&nbsp;void&nbsp;close()</pre>
<dl>
<dt><span class="overrideSpecifyLabel">Specified by:</span></dt>
<dd><code><a href="../../../../gov/usgs/anss/edge/MiniSeedOutputHandler.html#close--">close</a></code>&nbsp;in interface&nbsp;<code><a href="../../../../gov/usgs/anss/edge/MiniSeedOutputHandler.html" title="interface in gov.usgs.anss.edge">MiniSeedOutputHandler</a></code></dd>
</dl>
</li>
</ul>
<a name="putbuf-byte:A-int-">
<!--   -->
</a>
<ul class="blockList">
<li class="blockList">
<h4>putbuf</h4>
<pre>public&nbsp;void&nbsp;putbuf(byte[]&nbsp;msbuf,
                   int&nbsp;len)</pre>
<div class="block">Handle the output from the RawToMiniSeed.</div>
<dl>
<dt><span class="overrideSpecifyLabel">Specified by:</span></dt>
<dd><code><a href="../../../../gov/usgs/anss/edge/MiniSeedOutputHandler.html#putbuf-byte:A-int-">putbuf</a></code>&nbsp;in interface&nbsp;<code><a href="../../../../gov/usgs/anss/edge/MiniSeedOutputHandler.html" title="interface in gov.usgs.anss.edge">MiniSeedOutputHandler</a></code></dd>
<dt><span class="paramLabel">Parameters:</span></dt>
<dd><code>msbuf</code> - </dd>
<dd><code>len</code> - </dd>
</dl>
</li>
</ul>
<a name="main-java.lang.String:A-">
<!--   -->
</a>
<ul class="blockListLast">
<li class="blockList">
<h4>main</h4>
<pre>public static&nbsp;void&nbsp;main(java.lang.String[]&nbsp;args)</pre>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<!-- ========= END OF CLASS DATA ========= -->
<!-- ======= START OF BOTTOM NAVBAR ====== -->
<div class="bottomNav"><a name="navbar.bottom">
<!--   -->
</a>
<div class="skipNav"><a href="#skip.navbar.bottom" title="Skip navigation links">Skip navigation links</a></div>
<a name="navbar.bottom.firstrow">
<!--   -->
</a>
<ul class="navList" title="Navigation">
<li><a href="../../../../overview-summary.html">Overview</a></li>
<li><a href="package-summary.html">Package</a></li>
<li class="navBarCell1Rev">Class</li>
<li><a href="package-tree.html">Tree</a></li>
<li><a href="../../../../deprecated-list.html">Deprecated</a></li>
<li><a href="../../../../index-all.html">Index</a></li>
<li><a href="../../../../help-doc.html">Help</a></li>
</ul>
</div>
<div class="subNav">
<ul class="navList">
<li><a href="../../../../gov/usgs/anss/msread/RawDiskBigBuffer.html" title="class in gov.usgs.anss.msread"><span class="typeNameLink">Prev&nbsp;Class</span></a></li>
<li><a href="../../../../gov/usgs/anss/msread/ReorganizeFile.ChannelProcess.html" title="class in gov.usgs.anss.msread"><span class="typeNameLink">Next&nbsp;Class</span></a></li>
</ul>
<ul class="navList">
<li><a href="../../../../index.html?gov/usgs/anss/msread/ReorganizeFile.html" target="_top">Frames</a></li>
<li><a href="ReorganizeFile.html" target="_top">No&nbsp;Frames</a></li>
</ul>
<ul class="navList" id="allclasses_navbar_bottom">
<li><a href="../../../../allclasses-noframe.html">All&nbsp;Classes</a></li>
</ul>
<div>
<script type="text/javascript"><!--
  allClassesLink = document.getElementById("allclasses_navbar_bottom");
  if(window==top) {
    allClassesLink.style.display = "block";
  }
  else {
    allClassesLink.style.display = "none";
  }
  //-->
</script>
</div>
<div>
<ul class="subNavList">
<li>Summary:&nbsp;</li>
<li><a href="#nested.class.summary">Nested</a>&nbsp;|&nbsp;</li>
<li><a href="#field.summary">Field</a>&nbsp;|&nbsp;</li>
<li><a href="#constructor.summary">Constr</a>&nbsp;|&nbsp;</li>
<li><a href="#method.summary">Method</a></li>
</ul>
<ul class="subNavList">
<li>Detail:&nbsp;</li>
<li><a href="#field.detail">Field</a>&nbsp;|&nbsp;</li>
<li><a href="#constructor.detail">Constr</a>&nbsp;|&nbsp;</li>
<li><a href="#method.detail">Method</a></li>
</ul>
</div>
<a name="skip.navbar.bottom">
<!--   -->
</a></div>
<!-- ======== END OF BOTTOM NAVBAR ======= -->
</body>
</html>
